---
export const prerender = false;

import { supabase } from '../../lib/supabase';

const { city, vertical } = Astro.params;

// Normalize city slug
const cityName = city.replace(/-/g, ' ').toLowerCase();

// Display names for verticals (LOCKED — no "Emergency" duplication)
const verticalNames = {
  'water-damage-restoration': 'Water Damage Restoration',
  'emergency-plumbing': 'Plumbing',
  'mold-remediation': 'Mold Remediation',
  'fire-damage-restoration': 'Fire Damage Restoration',
  'hvac-emergency': 'HVAC Repair',
  'sewer-repair': 'Sewer Line Repair'
};

const verticalDisplay =
  verticalNames[vertical] ?? vertical.replace(/-/g, ' ');

// Fetch metro
const { data: metro } = await supabase
  .from('metros')
  .select('city, state')
  .ilike('city', cityName)
  .single();

// Fetch CTA config for this vertical
const { data: ctaConfig } = await supabase
  .from('vertical_cta_settings')
  .select('cta_enabled, default_cta_type')
  .eq('vertical_slug', vertical)
  .single();

// Fetch CTA phone number for this vertical
const { data: ctaPhone } = await supabase
  .from('cta_numbers')
  .select('phone_number')
  .eq('vertical_slug', vertical)
  .eq('is_active', true)
  .single();

const phoneNumber = ctaPhone?.phone_number ?? null;


// Fetch GLOBAL disclosures
const { data: globalDisclosures = [] } = await supabase
  .from('disclosures')
  .select('content')
  .eq('disclosure_type', 'global')
  .eq('language', 'en')
  .eq('is_active', true);

// Build disclosure HTML
const disclosureHtml =
  globalDisclosures.map(d => `<p>${d.content}</p>`).join('');
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <title>
      Emergency {verticalDisplay} in {metro?.city}, {metro?.state}
    </title>

    <meta
      name="description"
      content={`24/7 emergency ${verticalDisplay} services in ${metro?.city}, ${metro?.state}. Fast response. Licensed providers.`}
    />
  </head>

  <body>
    <!-- HERO -->
    <section>
      <h1>
        Emergency {verticalDisplay} in {metro?.city}, {metro?.state}
      </h1>

<p>
  <!-- TOP CTA -->
{ctaConfig?.cta_enabled && phoneNumber && (
  <section aria-label="Emergency Call CTA">
    <p style="font-size: 20px; font-weight: bold; margin: 16px 0;">
      <a
        href={`tel:${phoneNumber}`}
        style="color: #0055cc; text-decoration: underline;"
      >
        Call {phoneNumber.replace(/^1/, '1-').replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3')} for Immediate Help
      </a>
    </p>

    <p style="font-size: 14px;">
      Calls may be routed to a third-party service provider.
    </p>
  </section>
)}




      <p>
        If you need fast, professional emergency {verticalDisplay.toLowerCase()}
        services in {metro?.city}, {metro?.state}, you’re in the right place.
        We connect homeowners with experienced, licensed providers ready to
        respond quickly.
      </p>
    </section>

    <!-- SERVICE INFO -->
    <section>
      <h2>24/7 Emergency {verticalDisplay} Services</h2>

      <ul>
        <li>Fast emergency response</li>
        <li>Licensed and insured providers</li>
        <li>Residential and commercial services</li>
        <li>Available 24 hours a day</li>
      </ul>
    </section>

    <!-- CTA -->
    
      {ctaConfig?.cta_enabled && (
  <section aria-label="Emergency Service Call To Action">
    <h2>Request Emergency Service</h2>

    <p>
      Emergency service is available now. Call to be connected with a local,
      licensed provider for immediate assistance.
    </p>

    <p>
      <a
        href="tel:18005551234"
        style="font-weight: bold; font-size: 18px;"
      >
        Call Now for Immediate Help
      </a>
    </p>

    <p style="font-size: 14px;">
      Calls may be routed to a third-party service provider.
    </p>
  </section>
)}



    <!-- DISCLOSURES -->
    <footer>
      <h3>Disclosures</h3>
      <div set:html={disclosureHtml}></div>
    </footer>
  </body>
</html>



